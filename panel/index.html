<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Raven Panel - مدیریت حساب‌های بازی</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root{
            --primary:#6366f1;
            --primary-dark:#4f46e5;
            --background:#0f172a;
            --surface:#1e293b;
            --border:#334155;
            --text:#f1f5f9;
            --text-muted:#94a3b8;
            --gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        }
        *{box-sizing:border-box;margin:0;padding:0}
        body{
            font-family: 'Segoe UI', Tahoma, Roboto, "Vazirmatn", sans-serif;
            background:var(--background);
            color:var(--text);
            min-height:100vh;
            direction:rtl;
            -webkit-font-smoothing:antialiased;
        }
        .glass-effect{
            background:rgba(30,41,59,0.75);
            border:1px solid var(--border);
            border-radius:1rem;
            backdrop-filter: blur(6px);
        }
        .gradient-bg{background:var(--gradient)}
        .input-field{
            background:transparent;border:1px solid var(--border);color:var(--text);
            padding:0.75rem 1rem;border-radius:0.5rem;width:100%;
        }
        .input-field:focus{outline:none;box-shadow:0 0 0 3px rgba(99,102,241,0.12)}
        .btn-primary{
            background:var(--primary);color:white;padding:.75rem 1rem;border-radius:.6rem;border:0;font-weight:700;
            cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:.5rem;
        }
        .btn-primary[disabled]{opacity:.5;cursor:not-allowed}
        .server-badge{padding:.25rem .75rem;border-radius:999px;font-weight:700}
        .status-online{width:.75rem;height:.75rem;border-radius:50%;background:#10b981}
        .status-offline{width:.75rem;height:.75rem;border-radius:50%;background:#6b7280}
        .user-card{transition:all .18s ease;cursor:pointer}
        .user-card:hover{transform:translateY(-6px);box-shadow:0 10px 30px rgba(0,0,0,.6)}
        .loading-spinner{border:2px solid transparent;border-top:2px solid currentColor;border-radius:50%;width:1.25rem;height:1.25rem;animation:spin 1s linear infinite}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        .fade-in{animation:fadeIn .28s ease}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
        .count-badge{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:999px;font-weight:700}
        .notification{
            position:fixed;top:20px;left:20px;z-index:9999;padding:12px 20px;border-radius:8px;
            color:white;font-weight:500;animation:slideIn 0.3s ease;max-width:300px;
        }
        .notification.success{background:#10b981}
        .notification.error{background:#ef4444}
        .notification.info{background:#3b82f6}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        @media (max-width:960px){ .layout { padding:18px } }
    </style>
</head>
<body>
<div id="app"></div>

<script>
/* -----------------------
   Raven Panel - GitHub Pages + Cloudflare Workers + D1
   ----------------------- */

// Cloudflare Worker URL - این را با آدرس Worker خود جایگزین کنید
const API_BASE = 'https://ravenshoppanel.bloodstrike.workers.dev/';

class RavenPanel {
  constructor(){
    this.state = {
      isLogin: true,
      showPassword: false,
      isLoggedIn: false,
      currentUser: null,
      users: [],
      selectedServer: 'all',
      selectedUser: null,
      loading: false,
      token: localStorage.getItem('raven_token') || null,
      formData: {
        username: '',
        email: '',
        gameId: '',
        server: 'ASIA',
        level: 1,
        rank: 'Bronze',
        password: ''
      }
    };

    this.servers = [
      { id: 'ASIA', name: 'ASIA', color:'#ef4444' },
      { id: 'EU-MENA', name: 'EU-MENA', color:'#3b82f6' },
      { id: 'AMERICAS', name:'AMERICAS', color:'#10b981' },
    ];

    this.ranks = ['Bronze','Silver','Gold','Platinum','Diamond','Master','Legend','Mythic'];

    this.init();
  }

  init(){
    this.checkAuthStatus();
    this.render();
    this.setupEventListeners();
  }

  /* ---------- authentication ---------- */
  async checkAuthStatus(){
    const token = this.state.token;
    if(!token) return;

    try {
      const res = await this.apiCall('/api/auth/me', 'GET');
      if(res.success){
        this.state.currentUser = res.user;
        this.state.isLoggedIn = true;
        await this.fetchUsers();
      } else {
        localStorage.removeItem('raven_token');
        this.state.token = null;
      }
    } catch(err){
      console.warn('Token validation failed:', err);
      localStorage.removeItem('raven_token');
      this.state.token = null;
    }
  }

  /* ---------- API calls ---------- */
  async apiCall(endpoint, method = 'GET', data = null){
    const config = {
      method,
      headers: {
        'Content-Type': 'application/json',
      }
    };

    if(this.state.token){
      config.headers['Authorization'] = `Bearer ${this.state.token}`;
    }

    if(data){
      config.body = JSON.stringify(data);
    }

    const response = await fetch(`${API_BASE}${endpoint}`, config);
    
    if(response.status === 401){
      localStorage.removeItem('raven_token');
      this.state.token = null;
      this.state.isLoggedIn = false;
      this.state.currentUser = null;
      this.render();
      throw new Error('Unauthorized');
    }

    if(!response.ok){
      const error = await response.json().catch(() => ({}));
      throw new Error(error.error || error.message || `HTTP ${response.status}`);
    }

    return response.json();
  }

  /* ---------- events ---------- */
  setupEventListeners(){
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-action]');
      if(!btn) return;
      e.preventDefault();
      const action = btn.dataset.action;
      this.handleAction(action, e);
    });

    document.addEventListener('input', (e) => {
      if(e.target && e.target.matches('[data-input]')) {
        const key = e.target.dataset.input;
        this.handleInput(key, e.target.value, e.target);
      }
    });
    
    document.addEventListener('change', (e) => {
      if(e.target && e.target.matches('[data-input]')) {
        const key = e.target.dataset.input;
        this.handleInput(key, e.target.value, e.target);
      }
    });

    document.addEventListener('submit', (e) => {
      if(e.target && e.target.matches('#auth-form')){
        e.preventDefault();
        this.handleSubmit();
      }
    });
  }

  handleAction(action, event){
    switch(action){
      case 'toggle-auth':
        this.state.isLogin = !this.state.isLogin;
        this.state.formData.password = '';
        this.render();
        break;
      case 'toggle-password':
        this.state.showPassword = !this.state.showPassword;
        this.render();
        break;
      case 'logout':
        this.logout();
        break;
      case 'select-server':
        const srv = event.currentTarget.dataset.server;
        this.state.selectedServer = srv || 'all';
        this.fetchUsers();
        break;
      case 'view-user':
        const id = parseInt(event.currentTarget.dataset.userId);
        this.viewUser(id);
        break;
      case 'back-to-users':
        this.state.selectedUser = null;
        this.render();
        break;
      default:
        console.warn('Unknown action', action);
    }
  }

  handleInput(key, value){
    if(!key) return;
    if(key === 'level'){
      const n = parseInt(value) || 1;
      this.state.formData.level = Math.min(50, Math.max(1, n));
    } else {
      this.state.formData[key] = value;
    }
  }

  /* ---------- submit (login/register) ---------- */
  async handleSubmit(){
    if(!this.state.formData.username || !this.state.formData.password){
      this.showNotification('لطفاً نام کاربری/ایمیل و رمز را وارد کنید.', 'error');
      return;
    }
    if(!this.state.isLogin && !this.validateEmail(this.state.formData.email)){
      this.showNotification('لطفاً یک ایمیل معتبر وارد کنید.', 'error');
      return;
    }
    if(!this.state.isLogin && this.state.formData.password.length < 6){
      this.showNotification('رمز عبور باید حداقل 6 کاراکتر باشد.', 'error');
      return;
    }

    this.state.loading = true;
    this.render();

    try {
      const endpoint = this.state.isLogin ? '/api/auth/login' : '/api/auth/register';
      const payload = this.state.isLogin
        ? { identifier: this.state.formData.username, password: this.state.formData.password }
        : {
            username: this.state.formData.username,
            email: this.state.formData.email,
            accountId: this.state.formData.gameId,
            server: this.state.formData.server,
            password: this.state.formData.password
          };

      const data = await this.apiCall(endpoint, 'POST', payload);
      
      if(data.success){
        if(data.token){
          this.state.token = data.token;
          localStorage.setItem('raven_token', data.token);
        }
        
        this.state.currentUser = data.user;
        this.state.isLoggedIn = true;
        this.showNotification(this.state.isLogin ? 'خوش آمدید!' : 'ثبت‌نام با موفقیت انجام شد!', 'success');
        await this.fetchUsers();
      } else {
        this.showNotification(data.error || 'عملیات با خطا مواجه شد.', 'error');
      }
    } catch(err){
      console.error('Auth error:', err);
      this.showNotification(err.message || 'خطا در ارتباط با سرور', 'error');
    } finally {
      this.state.loading = false;
      this.render();
    }
  }

  /* ---------- fetch users ---------- */
  async fetchUsers(){
    this.state.loading = true;
    this.render();
    
    try {
      const params = new URLSearchParams();
      if(this.state.selectedServer && this.state.selectedServer !== 'all'){
        params.append('server', this.state.selectedServer);
      }
      
      const data = await this.apiCall(`/api/users?${params}`);
      if(data.success){
        this.state.users = data.users;
      }
    } catch(err){
      console.error('Fetch users error:', err);
      this.showNotification('خطا در دریافت لیست کاربران', 'error');
    } finally {
      this.state.loading = false;
      this.render();
    }
  }

  viewUser(id){
    const u = this.state.users.find(x => parseInt(x.id) === parseInt(id));
    if(u){
      this.state.selectedUser = u;
      this.updateUserLastActive(id);
      this.render();
    } else {
      this.showNotification('پروفایل پیدا نشد.', 'error');
    }
  }

  async updateUserLastActive(userId){
    try {
      await this.apiCall(`/api/users/${userId}/last-active`, 'POST');
    } catch(err){
      console.warn('Failed to update last active:', err);
    }
  }

  logout(){
    localStorage.removeItem('raven_token');
    this.state.token = null;
    this.state.isLoggedIn = false;
    this.state.currentUser = null;
    this.state.selectedUser = null;
    this.state.users = [];
    this.showNotification('با موفقیت خارج شدید.', 'success');
    this.render();
  }

  /* ---------- notifications ---------- */
  showNotification(message, type = 'info'){
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.style.animation = 'slideIn 0.3s ease reverse';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }

  /* ---------- rendering ---------- */
  sanitizeClassName(str){
    return (str || '').toString().toLowerCase().replace(/[^a-z0-9]+/g,'-');
  }

  render(){
    const app = document.getElementById('app');
    if(this.state.selectedUser){
      app.innerHTML = this.renderUserProfile();
    } else if(this.state.isLoggedIn){
      app.innerHTML = this.renderDashboard();
    } else {
      app.innerHTML = this.renderAuth();
    }

    if(typeof lucide !== 'undefined') lucide.createIcons();

    const submitBtn = document.querySelector('#app button[type="submit"]');
    if(submitBtn) submitBtn.disabled = !!this.state.loading;
  }

  renderAuth(){
    const showPwd = this.state.showPassword;
    return `
      <div class="min-h-screen flex items-center justify-center p-6 fade-in layout">
        <div class="w-full max-w-md">
          <div class="text-center mb-6">
            <div class="w-20 h-20 mx-auto mb-4 rounded-2xl flex items-center justify-center gradient-bg">
              <i data-lucide="gamepad-2" class="w-8 h-8 text-white"></i>
            </div>
            <h1 class="text-3xl font-bold mb-2">Raven Panel</h1>
            <p class="text-gray-400">مدیریت حساب‌های بازی</p>
          </div>

          <div class="glass-effect p-6">
            <div class="flex mb-4 rounded-lg p-1">
              <button data-action="toggle-auth" class="flex-1 py-2 px-4 rounded-md font-medium"
                style="background:${this.state.isLogin ? 'var(--primary)' : 'transparent'}; color:${this.state.isLogin ? '#fff' : 'var(--text-muted)'}">
                ورود
              </button>
              <button data-action="toggle-auth" class="flex-1 py-2 px-4 rounded-md font-medium"
                style="background:${!this.state.isLogin ? 'var(--primary)' : 'transparent'}; color:${!this.state.isLogin ? '#fff' : 'var(--text-muted)'}">
                ثبت‌نام
              </button>
            </div>

            <form id="auth-form" class="space-y-4">
              ${ this.state.isLogin ? this.renderLoginFields() : this.renderRegisterFields() }

              <div>
                <label class="block text-sm mb-2" for="password">رمز عبور</label>
                <div style="position:relative">
                  <input
                    id="password"
                    type="${ showPwd ? 'text' : 'password' }"
                    name="password"
                    data-input="password"
                    value="${this.escapeHtml(this.state.formData.password)}"
                    class="input-field pr-10"
                    placeholder="رمز عبور خود را وارد کنید"
                    required
                  />
                  <button type="button" data-action="toggle-password" style="position:absolute;left:.5rem;top:.4rem;border:0;background:transparent;color:var(--text-muted);">
                    <i data-lucide="${ showPwd ? 'eye-off' : 'eye' }" class="w-5 h-5"></i>
                  </button>
                </div>
              </div>

              <div>
                <button type="submit" ${ this.state.loading ? 'disabled' : '' } class="btn-primary w-full">
                  ${ this.state.loading ? '<span class="loading-spinner"></span>' : '' }
                  <span>${ this.state.isLogin ? 'ورود' : 'ثبت‌نام' }</span>
                </button>
              </div>
            </form>

            <div class="mt-4 text-center">
              <p class="text-gray-400">
                ${ this.state.isLogin ? 'حساب کاربری ندارید؟' : 'قبلاً ثبت‌نام کرده‌اید؟' }
                <button data-action="toggle-auth" class="font-medium mr-2" style="color:var(--primary)">${ this.state.isLogin ? 'ایجاد کنید' : 'وارد شوید' }</button>
              </p>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  renderLoginFields(){
    return `
      <div>
        <label class="block text-sm mb-2">ایمیل یا نام کاربری</label>
        <div style="position:relative">
          <input type="text" name="username" data-input="username" value="${this.escapeHtml(this.state.formData.username)}" class="input-field" placeholder="نام کاربری یا ایمیل خود را وارد کنید" required />
        </div>
      </div>
    `;
  }

  renderRegisterFields(){
    const serverOptions = this.servers.map(s => `<option value="${s.id}" ${ s.id === this.state.formData.server ? 'selected' : '' }>${s.name}</option>`).join('');
    const rankOptions = this.ranks.map(r => `<option value="${r}" ${ r === this.state.formData.rank ? 'selected' : '' }>${r}</option>`).join('');
    return `
      <div>
        <label class="block text-sm mb-2">نام کاربری</label>
        <input type="text" name="username" data-input="username" value="${this.escapeHtml(this.state.formData.username)}" class="input-field" placeholder="نام کاربری" required />
      </div>
      <div>
        <label class="block text-sm mb-2">ایمیل</label>
        <input type="email" name="email" data-input="email" value="${this.escapeHtml(this.state.formData.email)}" class="input-field" placeholder="ایمیل" required />
      </div>
      <div>
        <label class="block text-sm mb-2">شناسه بازی</label>
        <input type="text" name="gameId" data-input="gameId" value="${this.escapeHtml(this.state.formData.gameId)}" class="input-field" placeholder="شناسه بازی" required />
      </div>
      <div>
        <label class="block text-sm mb-2">سرور</label>
        <select name="server" data-input="server" class="input-field">
          ${serverOptions}
        </select>
      </div>
      <div>
        <label class="block text-sm mb-2">سطح</label>
        <input type="number" name="level" data-input="level" min="1" max="50" value="${this.escapeHtml(this.state.formData.level)}" class="input-field" />
      </div>
      <div>
        <label class="block text-sm mb-2">رنک</label>
        <select name="rank" data-input="rank" class="input-field">
          ${rankOptions}
        </select>
      </div>
    `;
  }

  renderDashboard(){
    const serverButtons = this.servers.map(s => {
      const active = this.state.selectedServer === s.id;
      return `<button data-action="select-server" data-server="${s.id}" class="server-badge" style="margin-left:.5rem;background:${active ? s.color : 'transparent'};color:${active ? '#fff' : s.color}">${s.name}</button>`;
    }).join('');
    return `
      <div class="min-h-screen p-4 fade-in layout">
        <header class="glass-effect p-4 mb-6">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="display:flex;gap:1rem;align-items:center">
              <div class="w-12 h-12 rounded-xl flex items-center justify-center gradient-bg"><i data-lucide="gamepad-2" class="w-6 h-6 text-white"></i></div>
              <div>
                <h1 class="text-2xl font-bold">Raven Panel</h1>
                <p class="text-gray-400">مدیریت حساب‌های بازی</p>
              </div>
            </div>
            <div style="display:flex;gap:1rem;align-items:center">
              <div style="text-align:left">
                <p class="text-sm text-gray-400">خوش آمدید</p>
                <p class="font-medium">${ this.state.currentUser ? this.escapeHtml(this.state.currentUser.username) : 'کاربر' }</p>
              </div>
              <button data-action="logout" class="btn-primary">خروج</button>
            </div>
          </div>
        </header>

        <main>
          <div class="glass-effect p-6 mb-6" style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h2 class="text-xl font-bold">لیست حساب‌ها</h2>
              <p class="text-gray-400">فیلتر بر اساس سرور</p>
            </div>
            <div style="display:flex;align-items:center;gap:.6rem">
              ${serverButtons}
              <button data-action="select-server" data-server="all" class="server-badge" style="background:${this.state.selectedServer === 'all' ? 'var(--primary)' : 'transparent'}; color:${this.state.selectedServer === 'all' ? '#fff' : 'var(--primary)'}">همه</button>
              <div class="count-badge" style="margin-right:.8rem">${this.state.users.length}</div>
            </div>
          </div>

          ${ this.state.loading ? `<div style="display:flex;justify-content:center;align-items:center;height:160px"><div class="loading-spinner" style="width:3rem;height:3rem"></div></div>` : `
            <div class="user-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              ${ this.state.users.map(u => this.renderUserCard(u)).join('') }
            </div>
          `}
        </main>
      </div>
    `;
  }

  renderUserCard(user){
    const serverClass = this.sanitizeClassName(user.server || 'unknown');
    const rankClass = this.sanitizeClassName(user.rank || 'bronze');
    return `
      <div class="user-card glass-effect p-5" data-action="view-user" data-user-id="${user.id}">
        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:.75rem">
          <div style="display:flex;gap:.75rem;align-items:center">
            <div class="w-12 h-12 rounded-full gradient-bg flex items-center justify-center"><i data-lucide="user" class="w-5 h-5 text-white"></i></div>
            <div>
              <div style="font-weight:800">${this.escapeHtml(user.username)}</div>
              <div style="color:var(--text-muted);font-size:.9rem">${this.escapeHtml(user.email || '')}</div>
            </div>
          </div>
          <div style="text-align:left">
            <div class="${user.status === 'online' ? 'status-online' : 'status-offline'}"></div>
          </div>
        </div>

        <div style="display:flex;flex-direction:column;gap:.5rem">
          <div style="display:flex;justify-content:space-between;color:var(--text-muted)"><span>سرور:</span><span class="server-badge">${this.escapeHtml(user.server)}</span></div>
          <div style="display:flex;justify-content:space-between;color:var(--text-muted)"><span>سطح:</span><span>Lv.${this.escapeHtml(user.level || 1)}</span></div>
          <div style="display:flex;justify-content:space-between;color:var(--text-muted)"><span>رنک:</span><span class="${rankClass}">${this.escapeHtml(user.rank || 'Bronze')}</span></div>
          <div style="display:flex;justify-content:space-between;color:var(--text-muted)"><span>آخرین فعالیت:</span><span>${this.escapeHtml(user.lastActive || 'نامشخص')}</span></div>
        </div>

        <button data-action="view-user" data-user-id="${user.id}" class="btn-primary w-full" style="margin-top:.8rem">مشاهده پروفایل</button>
      </div>
    `;
  }

  renderUserProfile(){
    const u = this.state.selectedUser;
    if(!u) return '<div>کاربر پیدا نشد</div>';
    return `
      <div class="min-h-screen p-4 fade-in layout">
        <header class="glass-effect p-4 mb-6">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="display:flex;gap:1rem;align-items:center">
              <button data-action="back-to-users" class="btn-primary"><i data-lucide="arrow-right" class="w-4 h-4"></i>بازگشت</button>
              <div>
                <h1 class="text-2xl font-bold">پروفایل کاربر</h1>
                <p class="text-gray-400">${this.escapeHtml(u.username)}</p>
              </div>
            </div>
            <div style="display:flex;gap:1rem;align-items:center">
              <div style="text-align:left"><p class="text-sm text-gray-400">خوش آمدید</p><p class="font-medium">${this.state.currentUser ? this.escapeHtml(this.state.currentUser.username) : 'کاربر'}</p></div>
              <button data-action="logout" class="btn-primary">خروج</button>
            </div>
          </div>
        </header>

        <main class="max-w-4xl mx-auto">
          <div class="glass-effect p-6">
            <div style="display:flex;gap:1rem;flex-direction:column">
              <div style="display:flex;gap:1.5rem;align-items:center">
                <div style="width:96px;height:96px;border-radius:999px" class="gradient-bg flex items-center justify-center"><i data-lucide="user" class="w-12 h-12 text-white"></i></div>
                <div>
                  <div style="font-weight:800;font-size:1.2rem">${this.escapeHtml(u.username)}</div>
                  <div style="color:var(--text-muted)">${this.escapeHtml(u.email || '')}</div>
                </div>
              </div>

              <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:1rem">
                <div>
                  <div style="color:var(--text-muted)">شناسه بازی</div><div style="font-weight:700">${this.escapeHtml(u.accountId || '')}</div>
                </div>
                <div>
                  <div style="color:var(--text-muted)">سرور</div><div style="font-weight:700">${this.escapeHtml(u.server)}</div>
                </div>
                <div>
                  <div style="color:var(--text-muted)">سطح</div><div style="font-weight:700">Lv.${this.escapeHtml(u.level || 1)}</div>
                </div>
                <div>
                  <div style="color:var(--text-muted)">رنک</div><div style="font-weight:700">${this.escapeHtml(u.rank || 'Bronze')}</div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    `;
  }

  escapeHtml(s){
    if(s === undefined || s === null) return '';
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  validateEmail(email){
    if(!email) return false;
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }
}

/* Initialize app */
document.addEventListener('DOMContentLoaded', () => {
  new RavenPanel();
});
</script>
</body>
</html>